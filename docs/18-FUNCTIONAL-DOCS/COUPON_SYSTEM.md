# Coupon System

## Overview

The coupon system provides revenue-aware discount codes with performance analytics, affiliate overlap detection, stacking rules, and auto-expiration of underperforming coupons. Coupons can be percentage-based or fixed-amount and support various constraints.

## Coupon Types

| Type | Description | Example |
|------|-------------|---------|
| `percentage` | Percentage off the order subtotal | 15% off |
| `fixed` | Fixed dollar amount off | $25 off |

## Coupon Properties

| Field | Description |
|-------|-------------|
| `code` | Unique coupon code (e.g., `SUMMER25`) |
| `type` | `percentage` or `fixed` |
| `value` | Discount value (percentage or dollar amount) |
| `active` | Whether the coupon is currently usable |
| `startDate` | Date the coupon becomes active |
| `endDate` | Date the coupon expires |
| `maxRedemptions` | Maximum total uses (null = unlimited) |
| `currentRedemptions` | Current number of uses |
| `minimumOrderAmount` | Minimum order subtotal required |
| `description` | Admin-facing description |

## Validation Rules

When a customer applies a coupon (`POST /api/coupons/validate`), the system checks:

1. **Existence** - Coupon code exists in the database
2. **Active status** - Coupon is marked as active
3. **Date range** - Current date is between `startDate` and `endDate`
4. **Usage limit** - `currentRedemptions` has not reached `maxRedemptions`
5. **Minimum order** - Order subtotal meets `minimumOrderAmount`

If all checks pass, the response includes the calculated discount amount.

```json
{
  "valid": true,
  "coupon": { "code": "SUMMER25", "type": "percentage", "value": 25 },
  "discount": 3750
}
```

## Stacking Rules

The coupon analytics system includes stacking validation (`validateStacking`):
- Determines if multiple coupons can be combined on a single order
- Checks for conflicts between coupon types
- Prevents stacking with affiliate discounts when configured
- Returns whether stacking is allowed and the combined discount

## Admin Management

### CRUD Operations

- `GET /api/admin/coupons` - List all coupons
- `POST /api/admin/coupons` - Create a new coupon
- `PATCH /api/admin/coupons/:id` - Update coupon properties
- `DELETE /api/admin/coupons/:id` - Delete a coupon

### Enable/Disable

- `POST /api/admin/coupon-analytics/admin/:couponId/disable` - Deactivate a coupon
- `POST /api/admin/coupon-analytics/admin/:couponId/enable` - Reactivate a coupon

### Auto-Expiration

`POST /api/admin/coupon-analytics/admin/auto-expire`

Automatically disables underperforming coupons based on:
- Low redemption rates
- Minimal revenue impact
- Expired date ranges

Returns the count and details of expired coupons.

## Analytics

### Summary

`GET /api/admin/coupon-analytics/admin/analytics?days=30`

Returns aggregate metrics:
- Total coupons (active vs. inactive)
- Total redemptions in period
- Total discount amount given
- Average discount per order
- Revenue impact analysis

### Performance

`GET /api/admin/coupon-analytics/admin/performance?days=30`

Returns per-coupon performance data:
- Redemption count and rate
- Total and average discount amounts
- Revenue generated by orders using the coupon
- ROI calculation (revenue vs. discount given)
- Affiliate overlap detection (coupons used with affiliate codes)

## Affiliate Overlap Detection

The analytics system identifies coupons that overlap with affiliate discounts:
- Tracks orders where both a coupon and affiliate code were used
- Reports the frequency and revenue impact of overlap
- Helps admins decide on stacking policies

## Integration with Checkout

During checkout:
1. Customer enters coupon code in the discount field
2. Frontend calls `/api/coupons/validate` with the code and order amount
3. If valid, discount is applied to the order total
4. Coupon code is stored with the order
5. `currentRedemptions` is incremented on successful payment

## Related Files

- `server/src/routes/admin/coupons.routes.ts` - Coupon CRUD and public validation
- `server/src/routes/admin/coupon-analytics.routes.ts` - Analytics and management
- `server/src/services/coupon-analytics.service.ts` - Analytics business logic
- `client/src/pages/admin-coupons.tsx` - Admin coupon management UI
